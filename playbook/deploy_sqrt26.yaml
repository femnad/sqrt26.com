---
- hosts:
    iridium
  name:
    Deploy sqrt26

  vars:
    deps:
      apt:
        - certbot
        - haproxy
        - jekyll
    repo:
      url:
        https://github.com/femnad/sqrt26.com.git
    certbot_standalone:
      domains:
        - sqrt26.com
        - www.sqrt26.com
      agree_tos:
        yes
      email: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        64393336646337373131613961616365326665633831613733303439303134353865323164626330
        6564393236613564303931373463613431643665316561630a353136393532343137636666626232
        33316666373266663463313665633330326434363632346166393266353163333230613934393934
        3337646261306266310a373636393632613932643864336532636664613439326161393439373135
        38616131623735396432613065666638396465313131633431616166623631326434
    haproxy_config:
      base_domain:
        sqrt26.com
      ip: "{{ ansible_default_ipv4.address }}"
      backend_server:
        127.0.0.1:4000
      backend:
        sqrt26

    systemd_service:
      absolute_exec: false
      description:
        Jekyll daemon for sqrt26.com
      name:
        jekyll-sqrt26
      exec:
        jekyll serve -s {{ source.path }}/jekyll -d {{ source.path }}/jekyll/_site
      service:
        Restart:
          always

  roles:
    - packages
    - clone
    - certbot_standalone
    - systemd-service
    - haproxy_config

  post_tasks:
    - name:
        Build static files
      command:
        jekyll build
      args:
        chdir:
          "{{ source.path }}/jekyll"
