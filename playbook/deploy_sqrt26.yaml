---
- hosts:
    stuff
  name:
    Deploy sqrt26

  vars:
    deps:
      apt:
        - haproxy
        - jekyll
    repo:
      url:
        https://github.com/femnad/sqrt26.com.git
    user_service:
      description:
        Jekyll server for sqrt26.com
      name:
        jekyll-sqrt26
      exec:
        /usr/bin/jekyll serve -s {{ source.path }}/jekyll -d {{ source.path }}/jekyll/_site

  roles:
    - packages
    - clone
    - systemd_user_service

  post_tasks:
    - name:
        Build static files
      command:
        jekyll build
      args:
        chdir:
          "{{ source.path }}/jekyll"

    - name:
        Restart Jekyll
      systemd:
        name:
          jekyll-sqrt26
        user:
          yes
        state:
          restarted

- import_playbook:
    manage_certificates.yaml
  tags:
    certbot

- import_playbook:
    configure_haproxy.yaml
  tags:
    haproxy
